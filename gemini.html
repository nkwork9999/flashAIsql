<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini Flash + DuckDB-Wasm ãƒ‡ãƒ¢</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 30px auto;
        padding: 20px;
        background: #f5f5f5;
        color: #333;
      }
      .container {
        background: white;
        padding: 20px;
        border: 1px solid #ddd;
      }
      h1 {
        color: #333;
        margin-bottom: 20px;
        font-size: 24px;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        background: #fafafa;
        border: 1px solid #e0e0e0;
      }
      h3 {
        margin-top: 0;
        font-size: 16px;
        color: #555;
      }
      button {
        background: #555;
        color: white;
        border: none;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 14px;
        margin: 5px 5px 5px 0;
      }
      button:hover {
        background: #333;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      input[type="text"],
      input[type="password"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        font-size: 14px;
        margin: 8px 0;
        box-sizing: border-box;
      }
      input[type="text"]:focus,
      input[type="password"]:focus {
        outline: none;
        border-color: #555;
      }
      .result {
        background: white;
        padding: 10px;
        margin-top: 10px;
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 13px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
      }
      .loading {
        color: #666;
        font-style: italic;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th,
      td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th {
        background: #555;
        color: white;
        font-weight: normal;
      }
      tr:hover {
        background: #f9f9f9;
      }
      .warning {
        background: #fffbf0;
        padding: 12px;
        margin: 15px 0;
        border-left: 3px solid #f90;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Gemini Flash + DuckDB-Wasm</h1>

      <div class="warning">
        <strong>APIã‚­ãƒ¼ãŒå¿…è¦:</strong>
        <a href="https://aistudio.google.com/app/apikey" target="_blank"
          >Google AI Studio</a
        >
        ã§Gemini APIã‚­ãƒ¼ã‚’å–å¾—ã—ã¦ãã ã•ã„
      </div>

      <div class="section">
        <h3>1. Gemini APIã‚­ãƒ¼è¨­å®š</h3>
        <input type="password" id="apiKey" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›" />
        <button onclick="saveApiKey()">ä¿å­˜</button>
      </div>

      <div class="section">
        <h3>2. DuckDB: ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä½œæˆ</h3>
        <button onclick="createSampleData()">ãƒ‡ãƒ¼ã‚¿ä½œæˆ</button>
        <div id="duckdbResult" class="result"></div>
      </div>

      <div class="section">
        <h3>3. DuckDB: SQLã‚¯ã‚¨ãƒªå®Ÿè¡Œ</h3>
        <input
          type="text"
          id="sqlQuery"
          placeholder="SELECT * FROM products"
          value="SELECT * FROM products"
        />
        <button onclick="executeQuery()">å®Ÿè¡Œ</button>
        <div id="queryResult" class="result"></div>
      </div>

      <div class="section">
        <h3>4. Gemini: ãƒ‡ãƒ¼ã‚¿åˆ†æ</h3>
        <button onclick="analyzeWithGemini()">åˆ†æå®Ÿè¡Œ</button>
        <div id="geminiResult" class="result"></div>
      </div>

      <div class="section">
        <h3>5. çµ±åˆ: SQLãƒ‡ãƒ¼ã‚¿ã‚’Geminiã§è¦ç´„</h3>
        <button onclick="analyzeSQLWithGemini()">ãƒ‡ãƒ¼ã‚¿å–å¾—â†’AIåˆ†æ</button>
        <div id="integrationResult" class="result"></div>
      </div>
    </div>

    <script type="module">
      import * as duckdb from "https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.28.0/+esm";

      let db;
      let conn;
      let apiKey = "";

      // DuckDBåˆæœŸåŒ–ï¼ˆä¿®æ­£ç‰ˆï¼‰
      async function initDuckDB() {
        if (db) return;

        try {
          const JSDELIVR_BUNDLES = duckdb.getJsDelivrBundles();
          const bundle = await duckdb.selectBundle(JSDELIVR_BUNDLES);

          const worker_url = URL.createObjectURL(
            new Blob([`importScripts("${bundle.mainWorker}");`], {
              type: "text/javascript",
            })
          );

          const worker = new Worker(worker_url);
          const logger = new duckdb.ConsoleLogger();
          db = new duckdb.AsyncDuckDB(logger, worker);
          await db.instantiate(bundle.mainModule, bundle.pthreadWorker);
          conn = await db.connect();

          console.log("DuckDBåˆæœŸåŒ–å®Œäº†");
        } catch (error) {
          console.error("DuckDBåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
          throw error;
        }
      }

      // APIã‚­ãƒ¼ä¿å­˜
      window.saveApiKey = function () {
        const key = document.getElementById("apiKey").value.trim();
        if (key) {
          apiKey = key;
          alert("APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸ!");
        } else {
          alert("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        }
      };

      // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä½œæˆ
      window.createSampleData = async function () {
        const resultDiv = document.getElementById("duckdbResult");
        resultDiv.innerHTML = '<p class="loading">ãƒ‡ãƒ¼ã‚¿ä½œæˆä¸­...</p>';

        try {
          await initDuckDB();

          await conn.query(`
                    CREATE OR REPLACE TABLE products (
                        id INTEGER,
                        name VARCHAR,
                        category VARCHAR,
                        price DECIMAL(10,2),
                        stock INTEGER
                    )
                `);

          await conn.query(`
                    INSERT INTO products VALUES
                    (1, 'ãƒãƒ¼ãƒˆPC', 'Electronics', 89900, 15),
                    (2, 'ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰', 'Electronics', 5980, 42),
                    (3, 'ãƒã‚¦ã‚¹', 'Electronics', 2980, 67),
                    (4, 'ãƒ‡ã‚¹ã‚¯', 'Furniture', 24900, 8),
                    (5, 'ãƒã‚§ã‚¢', 'Furniture', 34900, 12),
                    (6, 'ãƒ¢ãƒ‹ã‚¿ãƒ¼', 'Electronics', 29900, 23),
                    (7, 'æœ¬æ£š', 'Furniture', 12900, 18),
                    (8, 'ãƒ˜ãƒƒãƒ‰ãƒ›ãƒ³', 'Electronics', 15900, 31)
                `);

          const result = await conn.query("SELECT * FROM products");
          displayTable(result, resultDiv);
        } catch (error) {
          resultDiv.innerHTML = `<p style="color:red;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
          console.error(error);
        }
      };

      // SQLã‚¯ã‚¨ãƒªå®Ÿè¡Œ
      window.executeQuery = async function () {
        const query = document.getElementById("sqlQuery").value;
        const resultDiv = document.getElementById("queryResult");
        resultDiv.innerHTML = '<p class="loading">ã‚¯ã‚¨ãƒªå®Ÿè¡Œä¸­...</p>';

        try {
          await initDuckDB();
          const result = await conn.query(query);
          displayTable(result, resultDiv);
        } catch (error) {
          resultDiv.innerHTML = `<p style="color:red;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
        }
      };

      // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
      function displayTable(result, container) {
        const rows = result.toArray();
        if (rows.length === 0) {
          container.innerHTML = "<p>ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>";
          return;
        }

        const columns = Object.keys(rows[0]);
        let html = "<table><thead><tr>";
        columns.forEach((col) => {
          html += `<th>${col}</th>`;
        });
        html += "</tr></thead><tbody>";

        rows.forEach((row) => {
          html += "<tr>";
          columns.forEach((col) => {
            html += `<td>${row[col]}</td>`;
          });
          html += "</tr>";
        });

        html += "</tbody></table>";
        container.innerHTML = html;
      }

      // Gemini APIã‚’å‘¼ã³å‡ºã™
      async function callGemini(prompt) {
        if (!apiKey) {
          throw new Error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        }

        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              contents: [
                {
                  parts: [
                    {
                      text: prompt,
                    },
                  ],
                },
              ],
            }),
          }
        );

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error?.message || "APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼");
        }

        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
      }

      // Geminiã§ãƒ‡ãƒ¼ã‚¿åˆ†æ
      window.analyzeWithGemini = async function () {
        const resultDiv = document.getElementById("geminiResult");
        resultDiv.innerHTML = '<p class="loading">Geminiåˆ†æä¸­...</p>';

        try {
          const prompt =
            "DuckDBã¨WebAssemblyã‚’ä½¿ã£ãŸãƒ–ãƒ©ã‚¦ã‚¶å†…ãƒ‡ãƒ¼ã‚¿åˆ†æã®åˆ©ç‚¹ã‚’3ã¤ã€ç°¡æ½”ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚";
          const response = await callGemini(prompt);
          resultDiv.innerHTML = response;
        } catch (error) {
          resultDiv.innerHTML = `<p style="color:red;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
        }
      };

      // SQLãƒ‡ãƒ¼ã‚¿ã‚’Geminiã§åˆ†æ
      window.analyzeSQLWithGemini = async function () {
        const resultDiv = document.getElementById("integrationResult");
        resultDiv.innerHTML = '<p class="loading">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</p>';

        try {
          await initDuckDB();

          const result = await conn.query(
            "SELECT * FROM products ORDER BY price DESC"
          );
          const data = result.toArray();

          resultDiv.innerHTML = '<p class="loading">Geminiã§åˆ†æä¸­...</p>';

          const prompt = `ä»¥ä¸‹ã®å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ã€åœ¨åº«ç®¡ç†ã¨è²©å£²æˆ¦ç•¥ã«ã¤ã„ã¦3ã¤ã®é‡è¦ãªæ´å¯Ÿã‚’æä¾›ã—ã¦ãã ã•ã„:\n\n${JSON.stringify(
            data,
            null,
            2
          )}`;
          const analysis = await callGemini(prompt);

          resultDiv.innerHTML = `
                    <h4>ğŸ“Š å–å¾—ãƒ‡ãƒ¼ã‚¿ (${data.length}ä»¶)</h4>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                    <h4>ğŸ¤– Geminiã®åˆ†æçµæœ</h4>
                    <div>${analysis}</div>
                `;
        } catch (error) {
          resultDiv.innerHTML = `<p style="color:red;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
        }
      };
    </script>
  </body>
</html>
